<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Checker & Facebook Caption Extractor</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .drag-drop-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drag-drop-area.drag-over {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
                <i class="fas fa-images text-blue-500 mr-3"></i>
                AI Image Checker & Facebook Caption Extractor
            </h1>

            <!-- Reference Image Upload -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-cloud-upload-alt text-green-500 mr-2"></i>
                    1. Upload Reference Image
                </h2>
                <div id="dropArea" class="drag-drop-area p-8 text-center rounded-lg cursor-pointer">
                    <i class="fas fa-image text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 mb-2">Drag & drop your reference image here</p>
                    <p class="text-sm text-gray-400">or click to browse</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>
                <div id="imagePreview" class="mt-4 hidden">
                    <img id="previewImg" class="max-w-full h-48 object-contain mx-auto rounded-lg shadow-md">
                </div>
            </div>

            <!-- Facebook Links Input (Multiple) -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fab fa-facebook text-blue-600 mr-2"></i>
                    2. Enter Facebook Post Links (one per line)
                </h2>
                <div class="flex gap-4">
                    <textarea 
                        id="facebookLinks" 
                        placeholder="https://www.facebook.com/username/posts/...
https://www.facebook.com/share/...
https://www.facebook.com/permalink.php?id=..."
                        class="flex-1 px-4 py-3 h-32 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                    ></textarea>
                    <button 
                        id="analyzeBtn" 
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 flex items-center gap-2 self-start"
                    >
                        <i class="fas fa-search"></i>
                        Analyze
                    </button>
                </div>
            </div>

            

            <!-- Loading Indicator -->
            <div id="loadingDiv" class="hidden text-center py-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Analyzing with AI...</p>
            </div>

            <!-- Results Section (Only 3 outputs per link) -->
            <div id="resultsSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-list text-purple-500 mr-2"></i>
                    Results
                </h2>
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead>
                                <tr class="text-left text-gray-600">
                                    <th class="px-4 py-2">Name</th>
                                    <th class="px-4 py-2">Image</th>
                                    <th class="px-4 py-2">Caption</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="errorDiv" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        // API key is stored on the server (Netlify Function). No key in frontend.
        const MODEL_NAME = 'google/gemini-2.0-flash-001';

        // DOM Elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const facebookLinks = document.getElementById('facebookLinks');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingDiv = document.getElementById('loadingDiv');
        const resultsSection = document.getElementById('resultsSection');
        const errorDiv = document.getElementById('errorDiv');
        const errorMessage = document.getElementById('errorMessage');
        const resultsBody = document.getElementById('resultsBody');

        let referenceImageBase64 = null;

        // File Upload Handlers
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', handleDragOver);
        dropArea.addEventListener('drop', handleDrop);
        dropArea.addEventListener('dragenter', handleDragEnter);
        dropArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);
        analyzeBtn.addEventListener('click', analyzePosts);

        

        function handleDragOver(e) {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        }

        function handleDragEnter(e) {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                referenceImageBase64 = e.target.result;
                previewImg.src = referenceImageBase64;
                imagePreview.classList.remove('hidden');
                hideError();
            };
            reader.readAsDataURL(file);
        }

        

        async function analyzePosts() {
            const linksText = (facebookLinks.value || '').trim();

            if (!referenceImageBase64) {
                showError('Please upload a reference image first.');
                return;
            }

            if (!linksText) {
                showError('Please enter at least one Facebook post link.');
                return;
            }

            const links = linksText
                .split(/\r?\n/)
                .map(l => l.trim())
                .filter(l => l.length > 0 && l.includes('facebook.com'));

            if (links.length === 0) {
                showError('Please provide valid Facebook links (one per line).');
                return;
            }

            showLoading();
            hideError();

            try {
                const results = await analyzeLinksWithAI(links);
                renderResults(results);
                hideLoading();
            } catch (error) {
                console.error('Analysis error:', error);
                showError(`Analysis failed: ${error.message}`);
                hideLoading();
            }
        }

        async function analyzeLinksWithAI(links) {
            // 1) Scrape metadata for each link on the server (name, caption, og:image)
            const metas = await Promise.all(links.map(scrapeFacebookMeta));

            // 2) pHash-based comparison without AI
            const statuses = await Promise.all(
                metas.map(meta => classifySameRelative(referenceImageBase64, meta.imageUrl))
            );

            // 3) Build final results (exactly 3 fields)
            return metas.map((m, i) => ({
                name: normalizeName(m.name),
                image: statuses[i],
                caption: formatCaption(m.caption)
            }));
        }

        async function scrapeFacebookMeta(url) {
            const res = await fetch('/.netlify/functions/fb-scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            if (!res.ok) {
                return { name: 'unknown', caption: '', imageUrl: '' };
            }
            const data = await res.json();
            return {
                name: data.name || 'unknown',
                caption: data.caption || '',
                imageUrl: data.imageUrl || ''
            };
        }

        // ---- Non-AI image comparison (aHash/pHash-like) ----
        async function classifySameRelative(referenceDataUrl, postImageUrl) {
            if (!postImageUrl) return 'relative';
            try {
                const refHash = await imageDataUrlToHash(referenceDataUrl);
                const proxied = await fetch('/.netlify/functions/image-proxy', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: postImageUrl })
                });
                if (!proxied.ok) return 'relative';
                const { dataUrl } = await proxied.json();
                const postHash = await imageDataUrlToHash(dataUrl);
                const dist = hamming(refHash, postHash);
                return dist <= 10 ? 'same' : 'relative';
            } catch (_) {
                return 'relative';
            }
        }

        async function imageDataUrlToHash(dataUrl) {
            const img = new Image();
            img.src = dataUrl;
            await img.decode();
            const size = 8;
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, size, size);
            const { data } = ctx.getImageData(0, 0, size, size);
            const gray = [];
            for (let i = 0; i < data.length; i += 4) {
                gray.push(0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2]);
            }
            const avg = gray.reduce((a,b)=>a+b,0) / gray.length;
            return gray.map(v => (v > avg ? '1' : '0')).join('');
        }

        function hamming(a, b) {
            let d = 0; const n = Math.min(a.length, b.length);
            for (let i = 0; i < n; i++) if (a[i] !== b[i]) d++;
            return d;
        }

        // ---- Name/Caption normalization ----
        function normalizeName(name) {
            const n = (name || '').trim();
            if (!n) return 'unknown';
            // Strip common suffixes like " - Posts | Facebook"
            return n.replace(/\s*-\s*Posts\s*\|\s*Facebook$/i, '').trim();
        }

        function formatCaption(caption) {
            const c = (caption || '').trim();
            return c ? c : '';
        }

        function extractJsonArray(text) {
            try {
                return JSON.parse(text);
            } catch (_) {}
            // Try code block removal
            const matchCode = text.match(/```[\s\S]*?```/);
            if (matchCode) {
                const inner = matchCode[0].replace(/```json|```/g, '').trim();
                try { return JSON.parse(inner); } catch (_) {}
            }
            // Try bracket slicing
            const start = text.indexOf('[');
            const end = text.lastIndexOf(']');
            if (start !== -1 && end !== -1 && end > start) {
                const slice = text.slice(start, end + 1);
                try { return JSON.parse(slice); } catch (_) {}
            }
            return null;
        }

        function renderResults(items) {
            resultsBody.innerHTML = items.map(item => {
                const name = sanitize(String(item.name || 'unknown'));
                const isSame = String(item.image || 'relative') === 'same';
                const imageText = isSame ? 'Same' : 'not same';
                const captionText = String(item.caption || '');
                const caption = sanitize(captionText.startsWith('caption:') ? captionText : `caption: ${captionText}`);
                const badgeClass = isSame ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700';
                return `
                    <tr>
                        <td class="px-4 py-2 align-top">${name}</td>
                        <td class="px-4 py-2 align-top"><span class="px-2 py-1 rounded ${badgeClass}">${imageText}</span></td>
                        <td class="px-4 py-2 align-top whitespace-pre-wrap">${caption}</td>
                    </tr>
                `;
            }).join('');
            resultsSection.classList.remove('hidden');
        }

        function sanitize(str) {
            return str
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;');
        }

        function showLoading() {
            loadingDiv.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
        }

        function hideLoading() {
            loadingDiv.classList.add('hidden');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Analyze';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI Image Checker initialized');
        });
    </script>
</body>
</html>
