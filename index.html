<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Checker & Facebook Caption Extractor</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .drag-drop-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drag-drop-area.drag-over {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
                <i class="fas fa-images text-blue-500 mr-3"></i>
                AI Image Checker & Facebook Caption Extractor
            </h1>

            <!-- Reference Image Upload -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-cloud-upload-alt text-green-500 mr-2"></i>
                    1. Upload Reference Image
                </h2>
                <div id="dropArea" class="drag-drop-area p-8 text-center rounded-lg cursor-pointer">
                    <i class="fas fa-image text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 mb-2">Drag & drop your reference image here</p>
                    <p class="text-sm text-gray-400">or click to browse</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>
                <div id="imagePreview" class="mt-4 hidden">
                    <img id="previewImg" class="max-w-full h-48 object-contain mx-auto rounded-lg shadow-md">
                </div>
            </div>

            <!-- Facebook Links Input (Multiple) -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fab fa-facebook text-blue-600 mr-2"></i>
                    2. Enter Facebook Post Links (one per line)
                </h2>
                <div class="flex gap-4">
                    <textarea 
                        id="facebookLinks" 
                        placeholder="https://www.facebook.com/username/posts/...
https://www.facebook.com/share/...
https://www.facebook.com/permalink.php?id=..."
                        class="flex-1 px-4 py-3 h-32 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                    ></textarea>
                    <button 
                        id="analyzeBtn" 
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 flex items-center gap-2 self-start"
                    >
                        <i class="fas fa-search"></i>
                        Analyze
                    </button>
                </div>
            </div>

            <!-- Optional Cookie input for gated posts -->
            <details class="mb-8">
                <summary class="cursor-pointer text-sm text-gray-600">Optional: Paste your Facebook Cookie header (for private/gated posts)</summary>
                <div class="mt-3">
                    <textarea 
                        id="fbCookieInput"
                        placeholder="c_user=...; xs=...; fr=...; datr=..."
                        class="w-full px-4 py-3 h-20 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-2">Tip: In your browser DevTools Network tab, copy the <strong>Cookie</strong> header from a request to facebook.com while logged in. For local testing only; do not commit or share this value.</p>
                </div>
            </details>

            

            <!-- Loading Indicator -->
            <div id="loadingDiv" class="hidden text-center py-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Analyzing with AI...</p>
            </div>

            <!-- Results Section (Only 3 outputs per link) -->
            <div id="resultsSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-list text-purple-500 mr-2"></i>
                    Results
                </h2>
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead>
                                <tr class="text-left text-gray-600">
                                    <th class="px-4 py-2">Image</th>
                                    <th class="px-4 py-2">Name</th>
                                    <th class="px-4 py-2">Caption</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="errorDiv" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        // API key is stored on the server (Netlify Function). No key in frontend.
        const MODEL_NAME = 'google/gemini-2.0-flash-001';

        // DOM Elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const facebookLinks = document.getElementById('facebookLinks');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingDiv = document.getElementById('loadingDiv');
        const resultsSection = document.getElementById('resultsSection');
        const errorDiv = document.getElementById('errorDiv');
        const errorMessage = document.getElementById('errorMessage');
        const resultsBody = document.getElementById('resultsBody');
        const fbCookieInput = document.getElementById('fbCookieInput');

        let referenceImageBase64 = null;

        // Persist cookie locally (dev convenience)
        const COOKIE_KEY = 'fb_cookie_header';
        if (fbCookieInput) {
            fbCookieInput.value = localStorage.getItem(COOKIE_KEY) || '';
            fbCookieInput.addEventListener('input', () => {
                localStorage.setItem(COOKIE_KEY, fbCookieInput.value || '');
            });
        }

        // File Upload Handlers
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', handleDragOver);
        dropArea.addEventListener('drop', handleDrop);
        dropArea.addEventListener('dragenter', handleDragEnter);
        dropArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);
        analyzeBtn.addEventListener('click', analyzePosts);

        

        function handleDragOver(e) {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        }

        function handleDragEnter(e) {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                referenceImageBase64 = e.target.result;
                previewImg.src = referenceImageBase64;
                imagePreview.classList.remove('hidden');
                hideError();
            };
            reader.readAsDataURL(file);
        }

        

        async function analyzePosts() {
            const linksText = (facebookLinks.value || '').trim();

            if (!linksText) {
                showError('Please enter at least one Facebook post link.');
                return;
            }

            // Extract valid Facebook URLs from free-form input (handles prefixes like "@" or "Repost link:")
            const urlRegex = /(https?:\/\/(?:www\.)?facebook\.com\/[^\s<>"')]+)/gi;
            const links = Array.from(new Set((linksText.match(urlRegex) || [])
                .map(u => u.replace(/^@+/, '').trim())));

            if (links.length === 0) {
                showError('Please provide valid Facebook links (one per line).');
                return;
            }

            showLoading();
            hideError();

            try {
                const results = await analyzeLinksWithAI(links);
                renderResults(results);
                hideLoading();
            } catch (error) {
                console.error('Analysis error:', error);
                showError(`Analysis failed: ${error.message}`);
                hideLoading();
            }
        }

        async function analyzeLinksWithAI(links) {
            // 1) Take a screenshot server-side for each link
            const shots = await Promise.all(links.map(screenshotFacebook));

            // 2) Extract fields from screenshot with AI
            const extracted = await Promise.all(shots.map(s => aiExtractFromScreenshot(s?.dataUrl || '')));

            // 3) Build final results: image screenshot + minimal fields
            return extracted.map((e, i) => ({
                screenshot: shots[i]?.dataUrl || '',
                name: normalizeName(e?.name || ''),
                caption: formatCaption(e?.caption || '')
            }));
        }

        async function screenshotFacebook(url) {
            try {
                const res = await fetch('/.netlify/functions/screenshot-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url, 
                        // Send cookie header string if provided (backend also supports env vars)
                        cookie: (fbCookieInput?.value || '').trim() 
                    })
                });
                if (!res.ok) throw new Error('Screenshot failed');
                return await res.json();
            } catch (e) {
                return { dataUrl: '' };
            }
        }

        async function scrapeFacebookMeta(url) {
            const res = await fetch('/.netlify/functions/fb-scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            if (!res.ok) {
                return { name: 'unknown', caption: '', imageUrl: '', ogTitle: '', ogDesc: '', rawTitle: '' };
            }
            const data = await res.json();
            return {
                name: data.name || 'unknown',
                caption: data.caption || '',
                imageUrl: data.imageUrl || '',
                ogTitle: data.ogTitle || '',
                ogDesc: data.ogDesc || '',
                rawTitle: data.rawTitle || ''
            };
        }

        // ---- Non-AI image comparison (aHash/pHash-like) ----
        async function classifySameRelative(referenceDataUrl, postImageUrl) {
            if (!postImageUrl) return 'not same';
            try {
                const refHash = await imageDataUrlToHash(referenceDataUrl);
                const proxied = await fetch('/.netlify/functions/image-proxy', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: postImageUrl })
                });
                if (!proxied.ok) return 'not same';
                const { dataUrl } = await proxied.json();
                const postHash = await imageDataUrlToHash(dataUrl);
                const dist = hamming(refHash, postHash);
                // Slightly higher threshold to reduce false negatives on recompressed images
                return dist <= 14 ? 'same' : 'not same';
            } catch (_) {
                return 'not same';
            }
        }

        async function imageDataUrlToHash(dataUrl) {
            const img = new Image();
            img.src = dataUrl;
            await img.decode();
            const size = 8;
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, size, size);
            const { data } = ctx.getImageData(0, 0, size, size);
            const gray = [];
            for (let i = 0; i < data.length; i += 4) {
                gray.push(0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2]);
            }
            const avg = gray.reduce((a,b)=>a+b,0) / gray.length;
            return gray.map(v => (v > avg ? '1' : '0')).join('');
        }

        function hamming(a, b) {
            let d = 0; const n = Math.min(a.length, b.length);
            for (let i = 0; i < n; i++) if (a[i] !== b[i]) d++;
            return d;
        }

        // ---- Name/Caption normalization ----
        function normalizeName(name) {
            const n = (name || '').trim();
            if (!n) return 'unknown';
            // Strip common suffixes like " - Posts | Facebook"
            return n.replace(/\s*-\s*Posts\s*\|\s*Facebook$/i, '').trim();
        }

        function formatCaption(caption) {
            const c = (caption || '').trim();
            return c ? c : '';
        }

        async function maybeAiEnhance(meta, url) {
            const nameIsGeneric = !meta.name || /^\s*$/.test(meta.name) || /^(unknown|facebook)$/i.test(meta.name);
            const captionIsMissing = !meta.caption || /^\s*$/.test(meta.caption);
            if (!nameIsGeneric && !captionIsMissing) return meta;

            try {
                const improved = await aiExtractFields({
                    url,
                    name: meta.name || '',
                    caption: meta.caption || '',
                    ogTitle: meta.ogTitle || '',
                    ogDesc: meta.ogDesc || '',
                    rawTitle: meta.rawTitle || ''
                });
                return {
                    ...meta,
                    name: improved.name || meta.name || 'unknown',
                    caption: improved.caption || meta.caption || ''
                };
            } catch (e) {
                return meta;
            }
        }

        async function aiExtractFields(payload) {
            const system = 'You are a precise extractor. From the provided Facebook-like metadata, return a minimal JSON object with keys name and caption. Do not invent facts. If unavailable, leave as empty string.';
            const user = `Input JSON:\n${JSON.stringify(payload)}`;
            const res = await fetch('/.netlify/functions/openrouter-proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    messages: [
                        { role: 'system', content: system },
                        { role: 'user', content: user }
                    ],
                    temperature: 0.0
                })
            });
            if (!res.ok) throw new Error('AI request failed');
            const data = await res.json();
            const text = data?.choices?.[0]?.message?.content || '';
            const obj = extractJsonObject(text) || safeDirectJson(text);
            if (obj && typeof obj === 'object') return { name: obj.name || '', caption: obj.caption || '' };
            return { name: '', caption: '' };
        }

        function extractJsonObject(text) {
            try { const o = JSON.parse(text); return typeof o === 'object' ? o : null; } catch (_) {}
            const matchCode = text.match(/```[\s\S]*?```/);
            if (matchCode) {
                const inner = matchCode[0].replace(/```json|```/g, '').trim();
                try { const o = JSON.parse(inner); return typeof o === 'object' ? o : null; } catch (_) {}
            }
            const start = text.indexOf('{');
            const end = text.lastIndexOf('}');
            if (start !== -1 && end !== -1 && end > start) {
                const slice = text.slice(start, end + 1);
                try { const o = JSON.parse(slice); return typeof o === 'object' ? o : null; } catch (_) {}
            }
            return null;
        }

        function safeDirectJson(text) {
            if (!text) return null;
            const m = text.match(/\{\s*\"name\"[\s\S]*\}\s*$/);
            if (!m) return null;
            try { return JSON.parse(m[0]); } catch (_) { return null; }
        }

        function extractJsonArray(text) {
            try {
                return JSON.parse(text);
            } catch (_) {}
            // Try code block removal
            const matchCode = text.match(/```[\s\S]*?```/);
            if (matchCode) {
                const inner = matchCode[0].replace(/```json|```/g, '').trim();
                try { return JSON.parse(inner); } catch (_) {}
            }
            // Try bracket slicing
            const start = text.indexOf('[');
            const end = text.lastIndexOf(']');
            if (start !== -1 && end !== -1 && end > start) {
                const slice = text.slice(start, end + 1);
                try { return JSON.parse(slice); } catch (_) {}
            }
            return null;
        }

        function renderResults(items) {
            resultsBody.innerHTML = items.map(item => {
                const name = sanitize(String(item.name || 'unknown'));
                const img = String(item.screenshot || '');
                const captionText = String(item.caption || '');
                const caption = sanitize(captionText);
                return `
                    <tr>
                        <td class="px-4 py-2 align-top">${img ? `<img src="${img}" alt="post" class="h-24 w-24 object-cover rounded shadow"/>` : ''}</td>
                        <td class="px-4 py-2 align-top">${name}</td>
                        <td class="px-4 py-2 align-top whitespace-pre-wrap">${caption}</td>
                    </tr>
                `;
            }).join('');
            resultsSection.classList.remove('hidden');
        }

        async function aiExtractFromScreenshot(dataUrl) {
            if (!dataUrl) return { name: '', caption: '' };
            const instruction = 'You are a precise extractor. From this Facebook post screenshot image, extract only two fields: name (poster/page/user name) and caption (main post text). Return strict JSON {"name":"...","caption":"..."}. Do not add any other keys. If a field is not visible, use an empty string.';
            const payload = {
                model: MODEL_NAME,
                messages: [
                    {
                        role: 'user',
                        content: [
                            { type: 'text', text: instruction },
                            { type: 'image_url', image_url: { url: dataUrl } }
                        ]
                    }
                ],
                temperature: 0
            };
            const res = await fetch('/.netlify/functions/openrouter-proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) return { name: '', caption: '' };
            const data = await res.json();
            const text = data?.choices?.[0]?.message?.content || '';
            const obj = extractJsonObject(text) || safeDirectJson(text);
            if (obj && typeof obj === 'object') return { name: obj.name || '', caption: obj.caption || '' };
            return { name: '', caption: '' };
        }

        function sanitize(str) {
            return str
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;');
        }

        function showLoading() {
            loadingDiv.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
        }

        function hideLoading() {
            loadingDiv.classList.add('hidden');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Analyze';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI Image Checker initialized');
        });
    </script>
</body>
</html>
